<!-- Login Screen -->
<div class="main-container" *ngIf="!isLoggedIn">
  <div class="content">
    <div class="login-container">
      <h1>Welcome to Helpdesk</h1>
      <p>Please login to continue</p>
      <button (click)="login()" class="login-btn">Login with Keycloak</button>
    </div>
  </div>
</div>

<!-- Password Setup Page (no sidebar/navbar) -->
<div *ngIf="isLoggedIn && isPasswordSetupPage()">
  <router-outlet></router-outlet>
</div>

<!-- Main App Layout with Sidebar and Navbar -->
<div *ngIf="isLoggedIn && !isPasswordSetupPage()" class="flex h-screen bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-white flex-shrink-0 relative flex flex-col">
    <div class="p-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path
          d="M3 11h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm0 0a9 9 0 1 1 18 0m0 0v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3Z" />
        <path d="M21 16v2a4 4 0 0 1-4 4h-5" />
      </svg>
      <span class="text-xl font-semibold">Helpdesk</span>
    </div>

    <ul class="mt-6 flex-1 overflow-y-auto pb-24">
      <!-- Dashboard -->
      <li>
        <a (click)="navigateToDashboard()"
          class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 transition-colors cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8" />
            <path
              d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          </svg>
          <span>Dashboard</span>
        </a>
      </li>

      <!-- Users (Admin Only) -->
      <li *ngIf="isAdmin()">
        <button (click)="toggleUsersMenu()"
          class="w-full flex items-center justify-between px-4 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
              <path d="M16 3.128a4 4 0 0 1 0 7.744" />
              <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
              <circle cx="9" cy="7" r="4" />
            </svg>
            <span>Users</span>
          </div>
          <svg class="h-4 w-4 transition-transform" [ngClass]="{'transform rotate-90': usersMenuOpen}"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <polyline points="9 6 15 12 9 18" />
          </svg>
        </button>
        <ul *ngIf="usersMenuOpen" class="bg-gray-900 py-2">
          <li>
            <a (click)="navigateToUserManagement()"
              class="pl-12 py-2 flex items-center text-gray-400 hover:text-white hover:bg-gray-700 transition-colors cursor-pointer">
              User Management
            </a>
          </li>
        </ul>
      </li>

      <!-- Departments (Admin Only) -->
      <li *ngIf="isAdmin()">
        <button (click)="toggleDepartmentsMenu()"
          class="w-full flex items-center justify-between px-4 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 22" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h6v6H4z" />
              <path d="M14 4h6v6h-6z" />
              <path d="M4 14h6v6H4z" />
              <path d="M14 14h6v6h-6z" />
            </svg>
            <span>Departments</span>
          </div>
          <svg class="h-4 w-4 transition-transform" [ngClass]="{'transform rotate-90': departmentsMenuOpen}"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <polyline points="9 6 15 12 9 18" />
          </svg>
        </button>
        <ul *ngIf="departmentsMenuOpen" class="bg-gray-900 py-2">
          <li>
            <a (click)="navigateToDepartmentManagement()"
              class="pl-12 py-2 flex items-center text-gray-400 hover:text-white hover:bg-gray-700 transition-colors cursor-pointer">
              Department Management
            </a>
          </li>
        </ul>
      </li>

      <!-- Tickets -->
      <li>
        <button (click)="toggleTicketsMenu()"
          class="w-full flex items-center justify-between px-4 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
            </svg>
            <span>Tickets</span>
          </div>
          <svg class="h-4 w-4 transition-transform" [ngClass]="{'transform rotate-90': ticketsMenuOpen}"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <polyline points="9 6 15 12 9 18" />
          </svg>
        </button>
        <ul *ngIf="ticketsMenuOpen" class="bg-gray-900 py-2">
          <li>
            <a (click)="navigateToTicketManagement()"
              class="pl-12 py-2 flex items-center text-gray-400 hover:text-white hover:bg-gray-700 transition-colors cursor-pointer">
              Ticket Management
            </a>
          </li>
          <li *ngIf="isAdmin()">
            <a (click)="navigateToTicketHistory()"
              class="pl-12 py-2 flex items-center text-gray-400 hover:text-white hover:bg-gray-700 transition-colors cursor-pointer">
              Ticket History
            </a>
          </li>
        </ul>
      </li>
    </ul>

    <!-- Profile Section at Bottom -->
    <div class="absolute bottom-0 left-0 right-0 border-t border-gray-700">
      <div class="p-4">
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
              <span class="text-white font-semibold text-sm">{{ (username && username.charAt(0).toUpperCase()) || 'U' }}</span>
            </div>
          </div>
          <div class="flex-1 min-w-0 cursor-pointer" (click)="toggleProfileModal()">
            <p class="text-sm font-medium text-white truncate hover:text-purple-300 transition-colors">
              {{username || 'User'}}
            </p>
            <p class="text-xs text-gray-400 truncate">{{email || 'user@example.com'}}</p>
          </div>
          <button (click)="logout()" class="flex-shrink-0 text-gray-400 hover:text-red-400 transition-colors" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" x2="9" y1="12" y2="12" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm flex items-center justify-between px-6 py-3">
      <div>
        <span class="text-gray-700">Welcome <span class="font-bold">{{username}}</span></span>
      </div>
      <div class="flex items-center space-x-4">
        <!-- Notifications -->
        <app-notification-dropdown></app-notification-dropdown>
        <!-- Logout -->
        <button (click)="logout()" class="text-gray-600 hover:text-gray-900 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" x2="9" y1="12" y2="12" />
          </svg>
        </button>
      </div>
    </nav>

    <!-- Main content area -->
    <div class="flex-1 overflow-auto p-6 bg-gray-100">
      <router-outlet />
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div *ngIf="showProfileModal" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4"
     role="dialog" 
     aria-modal="true">
  <app-profile-modal
    [userProfile]="userProfile"
    (close)="closeProfileModal()"
    (update)="updateProfile($event)">
  </app-profile-modal>
</div>

<!-- Login Screen Styles -->
<style>
  .main-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .content {
    background: white;
    padding: 3rem;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    text-align: center;
    max-width: 500px;
    width: 90%;
  }

  .content h1 {
    color: #333;
    margin-bottom: 1rem;
    font-size: 2.5rem;
  }

  .content p {
    color: #666;
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  .login-btn {
    padding: 12px 30px;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
</style>
